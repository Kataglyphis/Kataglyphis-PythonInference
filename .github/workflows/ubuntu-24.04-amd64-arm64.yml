name: Build + test + run on Linux natively - x86-64/arm64

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    env:
      PACKAGE_NAME: kataglyphispythoninference
    strategy:
      matrix:
        include:
          - runs_on: ubuntu-24.04
            arch: x64
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            arch: arm64
            platform: linux/arm64

    runs-on: ${{ matrix.runs_on }}

    steps:
      - name: Free Disk Space on Host
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Prune Docker + show disk usage
        run: |
          set -eux
          docker system prune -af --volumes || true
          docker system df || true
          df -h

      - uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Login to GitHub Container Registry
        run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Pull container image
        run: |
          for i in 1 2 3; do
            echo "Attempt $i to pull container..."
            if timeout 900 docker pull ghcr.io/kataglyphis/kataglyphis_beschleuniger:latest; then
              echo "Successfully pulled container"
              docker system df || true
              exit 0
            fi
            echo "Pull failed, waiting before retry..."
            sleep 30
          done
          echo "Failed to pull container after 3 attempts"
          exit 1

      - name: Python static analysis
        run: |
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e MATRIX_ARCH=${{ matrix.arch }} \
            ghcr.io/kataglyphis/kataglyphis_beschleuniger:latest \
            bash -lc '
            set -e
            git config --global --add safe.directory /workspace || true
            uv venv .venv_static_analysis
            source .venv_static_analysis/bin/activate
            if [ -f uv.lock ]; then
              echo "uv.lock found â€” using locked sync"
              uv -v sync --locked --dev --all-extras --no-build-isolation-package wxpython
            else
              echo "No uv.lock found â€” performing non-locked sync"
              uv -v sync --dev --all-extras --no-build-isolation-package wxpython
            fi
            uv run codespell || true
            uv run mypy . || true
            uv run bandit -r . || true
            uv run vulture . || true
            uv run ruff check || true
            uv run ty check || true
            rm -r .venv
            '

      - name: Run Python tests
        run: |
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ghcr.io/kataglyphis/kataglyphis_beschleuniger:latest \
            bash -lc '
            set -e
            git config --global --add safe.directory /workspace || true

            # Ensure test results dir exists
            mkdir -p docs/test_results

            PY_VERSIONS="3.10 3.11 3.12 3.13 3.14 3.14t"   # adjust list to whatever you want

            for V in $PY_VERSIONS; do
              # create a venv using that interpreter, install deps and run tests
              uv venv .venv-${V} --python=${V}
              source .venv-${V}/bin/activate
              if [ -f uv.lock ]; then
                echo "uv.lock found â€” using locked sync"
                uv -v sync --locked --dev --all-extras --no-build-isolation-package wxpython
              else
                echo "No uv.lock found â€” performing non-locked sync"
                uv -v sync --dev --all-extras --no-build-isolation-package wxpython
              fi

              # run tests using that python
              uv run pytest tests/unit -v \
                --cov=${{ env.PACKAGE_NAME }} \
                --cov-report=term-missing \
                --cov-report=html:docs/test_results/coverage-html-${V} \
                --cov-report=xml:docs/test_results/coverage-${V}.xml \
                --junitxml=docs/test_results/report-${V}.xml \
                --html=docs/test_results/pytest-report-${V}.html \
                --self-contained-html \
                --md-report \
                --md-report-verbose=1 \
                --md-report-output docs/test_results/pytest-report-${V}.md || TEST_EXIT=$?

              uv run python bench/demo_cprofile.py || echo "demo_cprofile.py skipped"
              uv run python bench/demo_line_profiler.py || echo "demo_line_profiler.py skipped"
              uv run -m memory_profiler bench/demo_memory_profiling.py || echo "memory profiling skipped"

              # Attempt py-spy profiling; allow it to fail without failing the whole job
              uv run py-spy record --rate 200 --duration 10 -o docs/test_results/profile.svg -- python bench/demo_py_spy.py || echo "py-spy profiling skipped (may require a longer-running process or py-spy missing)"

              uv run pytest bench/demo_pytest_benchmark.py || echo "benchmark tests skipped or failed"
            done
            '

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6.0.0
        with:
          name: test-reports-${{ matrix.runs_on }}
          path: docs/test_results/

      - name: Build Docs
        if: ${{ matrix.arch == 'x64' }}
        run: |
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e MATRIX_ARCH=${{ matrix.arch }} \
            ghcr.io/kataglyphis/kataglyphis_beschleuniger:latest \
            bash -lc '
            set -e
            export PATH="$PWD/flutter/bin:$PATH"
            git config --global --add safe.directory /workspace || true
            
            uv venv .venv-docs
            source .venv-docs/bin/activate
            if [ -f uv.lock ]; then
              echo "uv.lock found â€” using locked sync"
              uv -v sync --locked --dev --all-extras --no-build-isolation-package wxpython
            else
              echo "No uv.lock found â€” performing non-locked sync"
              uv -v sync --dev --all-extras --no-build-isolation-package wxpython
            fi
            
            cp /workspace/README.md /workspace/docs/source/README.md
            cp /workspace/CHANGELOG.md /workspace/docs/source/CHANGELOG.md

            SRC=/workspace/docs/test_results
            STATIC_DIR=/workspace/docs/source/_static
            COVERAGE_DST=$STATIC_DIR/coverage
            TEST_RESULTS_DST=$STATIC_DIR/test_results

            mkdir -p "$COVERAGE_DST"
            mkdir -p "$TEST_RESULTS_DST"

            echo "Looking for coverage HTML in $SRC ..."
            if [ -d "$SRC/coverage-html-3.13" ]; then
              cp -r "$SRC/coverage-html-3.13/." "$COVERAGE_DST/"
              echo "Copied $SRC/coverage-html-3.13 -> $COVERAGE_DST/"
            elif [ -d "$SRC/coverage" ]; then
              cp -r "$SRC/coverage/." "$COVERAGE_DST/"
              echo "Copied $SRC/coverage -> $COVERAGE_DST/"
            elif [ -d "$SRC/htmlcov" ]; then
              cp -r "$SRC/htmlcov/." "$COVERAGE_DST/"
              echo "Copied $SRC/htmlcov -> $COVERAGE_DST/"
            else
              found=$(find "$SRC" -maxdepth 3 -type f -name index.html | grep -v pytest-report | head -n1 || true)
              if [ -n "$found" ]; then
                base=$(dirname "$found")
                cp -r "$base/." "$COVERAGE_DST/"
                echo "Copied discovered coverage HTML from $base -> $COVERAGE_DST/"
              else
                echo "No coverage HTML folder found in $SRC."
              fi
            fi

            if [ -f "$SRC/coverage-3.13.xml" ]; then
              cp "$SRC/coverage-3.13.xml" "$STATIC_DIR/coverage.xml"
              echo "Copied coverage-3.13.xml -> $STATIC_DIR/coverage.xml"
            elif [ -f "$SRC/coverage.xml" ]; then
              cp "$SRC/coverage.xml" "$STATIC_DIR/coverage.xml"
              echo "Copied coverage.xml -> $STATIC_DIR/coverage.xml"
            fi

            # Copy pytest HTML reports
            echo "Copying pytest HTML reports..."
            for html_file in "$SRC"/pytest-report-*.html; do
              if [ -f "$html_file" ]; then
                cp "$html_file" "$TEST_RESULTS_DST/"
                echo "Copied $(basename "$html_file") to $TEST_RESULTS_DST/"
              fi
            done

            # Also copy JUnit XML reports if you want them
            for xml_file in "$SRC"/report-*.xml; do
              if [ -f "$xml_file" ]; then
                cp "$xml_file" "$TEST_RESULTS_DST/"
                echo "Copied $(basename "$xml_file") to $TEST_RESULTS_DST/"
              fi
            done

            count=0

            for md_file in "$SRC"/pytest-report-*.md; do
              echo "  Found: $md_file"
              if cp "$md_file" "$STATIC_DIR/"; then
                echo "  Copied -> $STATIC_DIR/$(basename "$md_file")"
                count=$((count+1))
              else
                echo "  ERROR: Failed to copy $md_file"
              fi
            done

            cd docs
            make html

            OWNER_UID=$(stat -c "%u" /workspace)
            OWNER_GID=$(stat -c "%g" /workspace)
            echo "Fixing ownership of doc/api to ${OWNER_UID}:${OWNER_GID}"
            chown -R ${OWNER_UID}:${OWNER_GID} /workspace/doc || true
            '

      - name: Fix permissions for doc directory
        if: ${{ matrix.arch == 'x64' }}
        run: |
          chmod -R 755 ./doc/api/
          ls -la ./doc/api/

      - name: ðŸ“‚ Sync files to domain
        if: ${{ matrix.arch == 'x64' }}
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.SERVER }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PW }}
          local-dir: "./docs/build/html/"

      - name: Fix permissions for doc directory
        if: ${{ matrix.arch == 'x64' }}
        run: |
          chmod -R 755 ./doc/api/
          ls -la ./doc/api/

      - name: ðŸ“‚ Sync files to domain
        if: ${{ matrix.arch == 'x64' }}
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.SERVER }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PW }}
          local-dir: "./doc/api/"

      - name: Packaging application
        run: |
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ghcr.io/kataglyphis/kataglyphis_beschleuniger:latest \
            bash -lc '
            set -e
            export PATH="$PWD/flutter/bin:$PATH"
            git config --global --add safe.directory /workspace || true
            sudo apt-get update
            sudo apt-get install -y build-essential python3-dev \
              python3-setuptools python3-pip pkg-config libffi-dev libssl-dev \
              libatlas-base-dev libopenblas-dev liblapack-dev cython3 git \
              patchelf unzip zip

            uv venv .venv_packaging_sources
            source .venv_packaging_sources/bin/activate
            if [ -f uv.lock ]; then
              echo "uv.lock found â€” using locked sync"
              uv -v sync --locked --dev --all-extras --no-build-isolation-package wxpython
            else
              echo "No uv.lock found â€” performing non-locked sync"
              uv -v sync --dev --all-extras --no-build-isolation-package wxpython
            fi
            uv build
            export CYTHONIZE="True"
            uv venv .venv_packaging_binaries
            source .venv_packaging_binaries/bin/activate
            if [ -f uv.lock ]; then
              echo "uv.lock found â€” using locked sync"
              uv -v sync --locked --dev --all-extras --no-build-isolation-package wxpython
            else
              echo "No uv.lock found â€” performing non-locked sync"
              uv -v sync --dev --all-extras --no-build-isolation-package wxpython
            fi
            uv build 
            uv run auditwheel repair dist/*.whl -w dist/
            '
      
      - name: Upload packages (source/binary only)
        if: always()
        uses: actions/upload-artifact@v6.0.0
        with:
          name: packages-linux-${{ matrix.runs_on }}-source-and-binary
          path: /workspace/dist/
